"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
"""
from aiogram import Router, F
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from sqlalchemy import select, func
from datetime import datetime, timedelta

from database import async_session, User, BlockedUser, Product, Order
from config import settings
from utils.security import (
    SecurityValidator,
    block_user,
    unblock_user,
    is_user_blocked
)

router = Router()


class BroadcastStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏"""
    waiting_for_message = State()


class ProductStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"""
    waiting_for_name = State()
    waiting_for_description = State()
    waiting_for_price = State()
    waiting_for_image = State()


def admin_only(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""

    async def wrapper(message: Message, *args, **kwargs):
        if message.from_user.id != settings.ADMIN_ID:
            await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return
        return await func(message, *args, **kwargs)

    return wrapper


def admin_or_tech(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Ç–µ—Ö–º–µ–Ω–µ–¥–∂–µ—Ä–∞"""

    async def wrapper(message: Message, *args, **kwargs):
        if message.from_user.id not in [settings.ADMIN_ID, settings.TECH_MANAGER_ID]:
            await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return
        return await func(message, *args, **kwargs)

    return wrapper


@router.message(Command("admin"))
@admin_only
async def cmd_admin(message: Message):
    """–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    async with async_session() as session:
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        users_query = select(func.count(User.id))
        users_result = await session.execute(users_query)
        total_users = users_result.scalar()

        # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
        blocked_query = select(func.count(BlockedUser.id))
        blocked_result = await session.execute(blocked_query)
        total_blocked = blocked_result.scalar()

        # –ó–∞–∫–∞–∑—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        today = datetime.utcnow().date()
        orders_query = select(func.count(Order.id)).where(
            func.date(Order.created_at) == today
        )
        orders_result = await session.execute(orders_query)
        today_orders = orders_result.scalar()

    admin_text = (
        f"üîê –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n"
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
        f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
        f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {total_blocked}\n"
        f"üì¶ –ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è: {today_orders}\n\n"
        f"üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        f"/block [user_id] - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
        f"/unblock [user_id] - –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å\n"
        f"/broadcast - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É\n"
        f"/stats - –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        f"/add_product - –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä\n"
        f"/orders - –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤"
    )

    await message.answer(admin_text)


@router.message(Command("block"))
@admin_only
async def cmd_block_user(message: Message):
    """–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    args = message.text.split()
    if len(args) < 2:
        await message.answer(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /block [user_id] [–ø—Ä–∏—á–∏–Ω–∞]\n"
            "–ü—Ä–∏–º–µ—Ä: /block 123456789 —Å–ø–∞–º"
        )
        return

    try:
        user_id = int(args[1])
        reason = " ".join(args[2:]) if len(args) > 2 else None
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    # –ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞ –∏–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä
    if user_id in [settings.ADMIN_ID, settings.MONITOR_ID]:
        await message.answer("‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    async with async_session() as session:
        success = await block_user(
            session,
            user_id,
            message.from_user.id,
            reason
        )

        if success:
            await message.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                await message.bot.send_message(
                    user_id,
                    "‚õî –í—ã –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n"
                    f"–ü—Ä–∏—á–∏–Ω–∞: {reason or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}"
                )
            except:
                pass
        else:
            await message.answer(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")


@router.message(Command("unblock"))
@admin_only
async def cmd_unblock_user(message: Message):
    """–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    args = message.text.split()
    if len(args) < 2:
        await message.answer(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unblock [user_id]\n"
            "–ü—Ä–∏–º–µ—Ä: /unblock 123456789"
        )
        return

    try:
        user_id = int(args[1])
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    async with async_session() as session:
        success = await unblock_user(session, user_id)

        if success:
            await message.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                await message.bot.send_message(
                    user_id,
                    "‚úÖ –í—ã –±—ã–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–Ω–æ–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞."
                )
            except:
                pass
        else:
            await message.answer(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö.")


@router.message(Command("broadcast"))
@admin_or_tech
async def cmd_broadcast(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    await message.answer(
        "üì¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ.\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã."
    )
    await state.set_state(BroadcastStates.waiting_for_message)


@router.message(BroadcastStates.waiting_for_message)
@admin_or_tech
async def process_broadcast(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏"""
    if message.text == "/cancel":
        await state.clear()
        await message.answer("‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å", callback_data="broadcast_confirm"),
            InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="broadcast_cancel")
        ]
    ])

    await state.update_data(broadcast_message=message)
    await message.answer(
        "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?",
        reply_markup=keyboard
    )


@router.callback_query(F.data == "broadcast_confirm")
async def confirm_broadcast(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    if callback.from_user.id not in [settings.ADMIN_ID, settings.TECH_MANAGER_ID]:
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤!")
        return

    data = await state.get_data()
    broadcast_msg = data.get("broadcast_message")

    if not broadcast_msg:
        await callback.message.edit_text("‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await state.clear()
        return

    await callback.message.edit_text("üì§ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É...")

    async with async_session() as session:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        query = select(User.telegram_id)
        result = await session.execute(query)
        user_ids = [row[0] for row in result.fetchall()]

    success = 0
    failed = 0

    for user_id in user_ids:
        try:
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            async with async_session() as session:
                if await is_user_blocked(session, user_id):
                    continue

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if broadcast_msg.text:
                await callback.bot.send_message(user_id, broadcast_msg.text)
            elif broadcast_msg.photo:
                await callback.bot.send_photo(
                    user_id,
                    broadcast_msg.photo[-1].file_id,
                    caption=broadcast_msg.caption
                )
            elif broadcast_msg.video:
                await callback.bot.send_video(
                    user_id,
                    broadcast_msg.video.file_id,
                    caption=broadcast_msg.caption
                )

            success += 1
        except Exception as e:
            failed += 1

    await callback.message.edit_text(
        f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {success}\n"
        f"–ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {failed}"
    )
    await state.clear()


@router.callback_query(F.data == "broadcast_cancel")
async def cancel_broadcast(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    await callback.message.edit_text("‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
    await state.clear()


@router.message(Command("stats"))
@admin_or_tech
async def cmd_stats(message: Message):
    """–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    async with async_session() as session:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        total_users_query = select(func.count(User.id))
        total_users = (await session.execute(total_users_query)).scalar()

        # –ù–æ–≤—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é
        week_ago = datetime.utcnow() - timedelta(days=7)
        new_users_query = select(func.count(User.id)).where(User.created_at >= week_ago)
        new_users = (await session.execute(new_users_query)).scalar()

        # –ó–∞–∫–∞–∑—ã
        total_orders_query = select(func.count(Order.id))
        total_orders = (await session.execute(total_orders_query)).scalar()

        # –ó–∞–∫–∞–∑—ã –∑–∞ –Ω–µ–¥–µ–ª—é
        new_orders_query = select(func.count(Order.id)).where(Order.created_at >= week_ago)
        new_orders = (await session.execute(new_orders_query)).scalar()

        # –¢–æ–≤–∞—Ä—ã
        products_query = select(func.count(Product.id))
        total_products = (await session.execute(products_query)).scalar()

    stats_text = (
        f"üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n"
        f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n"
        f"  ‚Ä¢ –í—Å–µ–≥–æ: {total_users}\n"
        f"  ‚Ä¢ –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: {new_users}\n\n"
        f"üì¶ –ó–∞–∫–∞–∑—ã:\n"
        f"  ‚Ä¢ –í—Å–µ–≥–æ: {total_orders}\n"
        f"  ‚Ä¢ –ó–∞ –Ω–µ–¥–µ–ª—é: {new_orders}\n\n"
        f"üõçÔ∏è –¢–æ–≤–∞—Ä—ã:\n"
        f"  ‚Ä¢ –í –∫–∞—Ç–∞–ª–æ–≥–µ: {total_products}"
    )

    await message.answer(stats_text)